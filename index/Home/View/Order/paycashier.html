<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="" />
<meta name="author" content="网页作者的资料" />
<meta name="keywords" content="<?php echo $_SESSION['sc']['infor']['keywords']?>"></meta>
<meta name="description" content="<?php echo $_SESSION['sc']['infor']['description']?>"></meta>
<link rel="shortcut icon" href="/<?php echo $_SESSION['sc']['infor']['ico']?>" type="image/x-icon" />
<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="__PUBLIC__/Home/static/min.css/new/css/header_footer.min.css" />
<link rel="stylesheet" href="__PUBLIC__/Home/static/min.css/new/css/header_footer.min.css" />
<link rel="stylesheet" href="__PUBLIC__/Home/static/min.css/new/css/member.min.css" />
<link rel="stylesheet" href="__PUBLIC__/Home/static/min.css/css/front/new_join.min.css" />
<link rel="stylesheet" href="__PUBLIC__/Home/static/new/css/member_comm.css" />
<link rel="stylesheet" href="__PUBLIC__/Home/static/userCenter/css/login.css"/>
<link rel="stylesheet" href="__PUBLIC__/Home/static/css/front/login_box/login_box.css"/>
<link rel="stylesheet" href="__PUBLIC__/Home/static/new/css/balance.css" />
<title>付款--万花筒</title>
<style>
.top {
    padding: 20px 0;
    position: relative;
    width: 100%
}

.top img {
    float: left;
    margin: 25px auto;
}

.top p {
    font-size: 14px;
    color: #666;
    line-height: 24px;
}

.top span {
    position: absolute;
    right: 50px;
    top: 0px;
    font-weight: bold;
    color: #ff8208;
    font-size: 18px;
}

.center {
    border-top: 1px solid #999;
    position: relative;
    padding-top: 30px;
}

.center .after {
    position: absolute;
    top: -28px;
    right: 40px;
    line-height: 20px;
    background: red;
    font-size: 12px;
    padding: 4px 20px 4px 4px;
    border-radius: 4px 4px 0 0;
}

.center .after::after{
    content: "";
    position: absolute;
    border: 6px solid transparent;
    border-top: 6px solid #fff;
    top: 10px;
    right: 6px;
    z-index: 999;
}

.center .after a {
    color: #fff;
}

.center p {
    color: #666;
}

.center p span {
    line-height: 40px;
    font-size: 20px;
    color: red;
    line-height: 40px;
}

.bottom {
    padding-bottom: 20px;
    padding-top: 20px;
}

.bottom p {
    padding-bottom: 10px;
    color: #999;
    font-size: 12px;
}

.bottom>span {
    color: #ccc;
    font-size: 12px;
    margin-top: 20px;
}

.bottom a {
    font-size: 12px;
    padding-top: 10px;
    color: blue;
}

button {
    background: red;
    color: #fff;
    border-radius: 4px;
    padding: 10px 18px;
    border: 0;
    margin: 10px 0;
    font-size: 14px;
    float: left;
    margin-top: 20px;
}

.alieditContainer {
    position: relative;
    margin-bottom: 4px;
}

.alieditContainer .i-text {
    position: absolute;
    color: #fff;
    opacity: 0.2;
    width: 183px;
    height: 28px;
    font-size: 12px;
    left: 0;
    -webkit-user-select: initial;
    z-index: 9;
    border-radius: 5px;
    padding: 0;
}

.alieditContainer .sixDigitPassword {
    width: 185px;
    height: 22px;
    cursor: text;
    background: #fff;
    outline: none;
    position: relative;
    padding: 4px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.alieditContainer .sixDigitPassword i {
    width: 30px;
    height: 16px;
    float: left;
    display: block;
    padding: 4px 0;
    border-left: 1px solid #cccccc;
}

.alieditContainer .sixDigitPassword i:first-child {
    border-left: 0;
}

.alieditContainer .sixDigitPassword i.active {
    background-image: url("https://t.alipayobjects.com/images/rmsweb/T1nYJhXalXXXXXXXXX.gif");
    background-repeat: no-repeat;
    background-position: center center;
}

.alieditContainer .sixDigitPassword b {
    display: block;
    margin: 5px auto 4px auto;
    width: 7px;
    height: 7px;
    overflow: hidden;
    display: none;
    background: #000;
    border-radius: 100%;
}

table {
    width: 100%;
    float: right;
    display: none;
    margin-top: 50px;
    margin-bottom: 30px;
}

table th,
table td {
    border: 1px solid #ccc;
    text-align: center;
    line-height: 30px;
}

table tr td:nth-child(2) p {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 200px;
}

table tr td:nth-child(3) p {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 130px;
}

.cashier_desk_logo {
    width: 1200px;
    padding-left: 66px;
    margin: 25px auto;
    overflow: hidden;
    background: #fff;
}

.cashier_desk_logo img {
    float: left;
}

.cashier_desk_logo span {
    float: left;
    height: 40px;
    line-height: 40px;
    border-left: 1px solid #e0e0e0;
    color: #808080;
    font-size: 16px;
    font-weight: bold;
    margin: 3px 0 3px 0;
    padding-left: 20px;
    margin-left: 20px;
}
html,
body{
    height: 100%;
}
body{
    height: 100%;
    background: url(/Public/Home/static/new/img/images/back.png) no-repeat;
    -webkit-background-size: 100% 100%;
    background-size: 100% 100%;
}

.cashier_desk_pay {
    width: 100%;
    padding-top: 20px;
}

.cashier_desk_pay_con {
    width: 1150px;
    margin: 0 auto;
    background-color: #fff;
    border-radius: 5px;
    padding: 0 30px;
}

.cashier_desk_pay_con .title {
    height: 54px;
    line-height: 54px;
    padding: 15px 0 0 200px;
    position: relative;
}

.cashier_desk_pay_con .title p {
    color: #808080;
    font-size: 16px;
}

.title h3{
    /*line-height: 30px;*/
    position: absolute;
    left: 0;
}

.cashier_desk_pay_con .title span {
    display: block;
    width: 219px;
    height: 60px;
    font-size: 20px;
    color: #fff;
    font-weight: bold;
    text-align: center;
    position: absolute;
    top: 15px;
    left: -38px;
    background: url(/Public/Home/static/new/img/images/choose.png) no-repeat;
}

.dow {
    float: left;
    line-height: 50px;
    margin-left: 20px;
    color: #666;
    font-size: 14px;
    margin-top: 12px;
}

.dow i {
    color: red;
    font-size: 18px;
}
.loginContent{
    padding: 25px 0 0;
}
.a_login_register_box form .code span{
        position: absolute;
    display: block;
    width: 25px;
    height: 23px;
    background: url(/Public/Home/static/img/icon/input-icon-all.png) no-repeat 0 -387px;
    margin: 11px 12px;
    padding-right: 5px;
    border-right: 1px solid #dcdcdc;
}
.alieditContainer .sixDigitPassword i{
    width: 29px;
}
</style>
</head>

<body>
    <include file="public:pphead" />
    <div style="background: #fff;padding: 25px 0;">   
    <div class="cashier_desk_logo" style="margin: 0 auto;">
        <a href="/"><img src="__ROOT__/<{$_SESSION['sc']['infor']['logo']}>" alt="" /></a>
        <span>收银台</span>
    </div>
    </div>
    <div class="cashier_desk_pay">
        <div class="cashier_desk_pay_con">
            <div class="title">
                <span>订单信息</span>
                <p id="dingdan"></p><!-- 订单提交成功，请尽快付款！订单号：782229940216 -->
                <h3 id="duobi"></h3>
            </div>
            <div class="top">
                <div id="payOrder">
                    <table id="sontr">
                        <tr>
                            <th style="width:200px;">交易号</th>
                            <th style="width:200px;">商品名称</th>
                            <th style="width:130px;">店铺名称</th>
                            <th>可用金</th>
                            <th>消费币</th>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="center">
                <div class="after "><a href="#">订单详情</a></div>
                <p>支付可用金：<span id="payprice"></span></p>
                <p>支付消费币：<span id="payxfb"></span></p>
        </div>
        
        <div class="bottom">
            <p>万花筒支付密码：</p>
            <div class="alieditContainer" id="payPassword_container">
                <input minlength="6" maxlength="6" tabindex="1" id="payPassword_rsainput" name="payPassword_rsainput" class="ui-input i-text" oncontextmenu="return false" onpaste="return false" oncopy="return false" oncut="return false" autocomplete="off"  type="password" >
                <div class="sixDigitPassword" tabindex="0">
                    <i class="active"><b></b></i>
                    <i><b></b></i>
                    <i><b></b></i>
                    <i><b></b></i>
                    <i><b></b></i>
                    <i><b></b></i>
                </div>
            </div>
            <span>请输入6位数字支付密码</span>
                    <a href="javascript:setPayPass();">&nbsp忘记支付密码？</a>
                    <div style="clear: both;height: 20px;"></div>
                    <button type="button" id="dopay">确认付款</button>
                    <div class="dow">支付总额：<i id="paySumNum"></i></div>
                    <div style="clear: both;"></div>
            </div>
        </div>
        <div style="text-align: center;background: #333333; position: fixed;line-height: 30px;width: 100%;bottom: 0;color: #707e8c;">
            <?php echo $_SESSION['sc']['infor']['copyright']?>
        </div>
</body>
<div class="a_login_fixed_box a_login_register_box loginContent" style="z-index:1012;">
    <form class="a_login_register_form a_login_form">
        <div class="user" id="user">
           <span></span>
           <input type="text" id="mobile" class="border" readonly="readonly" value="<?php echo $_SESSION['sc']['usermobile']?>" maxlength="11"/>
        </div>
        <div class="code user" id="user">
        <span></span>
           <input type="text" id="code" class="border" placeholder="验证码" datacol='yes' checkexpession='NotNull' err='验证码' maxlength="11" style="width: 148px;" /><a href="javascript:getUserCode();" class="a_login_btn_go a_paypass_btn_go" style="display: inline-block;width: 90px;height: 46px;border-radius: 4px;margin-left: 20px;">手机验证码</a>
        </div>
        <div class="pas" id="pas">
           <span></span>
           <input type="password" id="paypass"  maxlength="6" placeholder="新密码" datacol='yes' checkexpession='Num' err='新密码不能为空，并且'/>
        </div>
        <div class="pas" id="pas">
           <span></span>
           <input type="password" id="respaypass"  maxlength="6" placeholder="确认密码" datacol='yes' checkexpession='Num' err='确认密码不能为空，并且'/>
        </div>
        <a href="javascript:void(0);" class="a_login_btn_go" id="paySubmit">重置密码</a>
    </form>
    <span class="a_world_close a_login_world_close"></span>
</div>
<div class="a_world_bg" style="z-index:1011"></div>
<script type="text/javascript" src="__PUBLIC__/Home/static/js/jquery-1.11.3.js"></script>
<script src="__PUBLIC__/Admin/javascripts/layer/layer.js"></script>
<script src="__PUBLIC__/Admin/javascripts/JValidator.js"></script>
<script>
function setPayPass(){
    var a = $(window).width(),
        c = $(window).height();
    $(".a_world_bg").css({
        height: c + "px"
    });
    $(".a_login_fixed_box").css({
        left: (a - $(".a_login_fixed_box").outerWidth()) / 2 + "px",
        top: (c - $(".a_login_fixed_box").outerHeight()) / 2 + "px"
    });
    $(".a_register_fixed_box").css({
        left: (a - $(".a_register_fixed_box").outerWidth()) / 2 + "px",
        top: (c - $(".a_register_fixed_box").outerHeight()) / 2 + "px"
    });
    $(".a_login_fixed_box").show();
    $(".a_world_bg").show();
    $(".a_login_world_close").click(function () {
        $(".a_world_bg").hide();
        $(".a_login_fixed_box").hide()
    })
}
function getUserCode(){
    var mobile=$("#mobile").val();
    var isMobile = /^0?1[3-8][0-9]\d{8}$/; // 手机号码验证规则
    if(mobile == '' || mobile == null){
        VerifyFailed('mobile','请填写手机号！');
        return false;
    } else if (!isMobile.test(mobile)) {
        VerifyFailed('mobile','手机号格式不正确！');
        return false;
    }else{
        checkValidCode();
    }
}
  /*发送验证码*/
function checkValidCode(){
  var mobile = $("#mobile").val();
  var time=120;
  var url = "<{:U('Register/checkValidCodeUSer')}>";
  $.ajax({
    type: "post",
    url: url,
    async: false,
    data:{mobile :mobile},
    error: function() {
                layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
            },
    success:function(data){
      if(data.infor == 2){
         $(".a_paypass_btn_go").attr("href","#");
          var t=setInterval(function  () {
          time--;
               $(".a_paypass_btn_go").html(time+"秒后获取");
              if (time==0) {
                  clearInterval(t);
                  $(".a_paypass_btn_go").attr("href","javascript:getUserCode();");
                  $(".a_paypass_btn_go").html("重新获取");
              }
          },1000) 
      }else if(data.infor == 3){
        layer.msg('验证码发送失败!',{offset: '300px',time: 1500,icon: 7}); return false;
      }else if(data.infor == 4){
        VerifyFailed('mobile','手机号不已存在，请填写新的手机号！'); return false;
      }
    }
  });
}
$("#paySubmit").click(function(){
    var mobile=$("#mobile").val();
    var code=$("#code").val();
    var pass=$("#paypass").val();
    var respass=$("#respaypass").val();
    var isMobile = /^0?1[3-8][0-9]\d{8}$/; // 手机号码验证规则
    if(mobile == '' || mobile == null){
        VerifyFailed('mobile','手机号码不能为空！');
        return false;
    }
    if (!isMobile.test(mobile)) {
        VerifyFailed('mobile','手机号格式不正确！');
        return false;
    }
    if(!/^[0-9]*$/.test(code)){
      VerifyFailed('code','短信验证码格式不正确！');
      return false;
    }
    if(pass == '' || pass == null){
        VerifyFailed('pass','请填写支付密码！');
        return false;
    }
    if(respass == '' || respass == null){
        VerifyFailed('pass','请填写确认密码！');
        return false;
    }
    if(pass != respass){
        VerifyFailed('respaypass','两次密码不一致！');
        return false;
    }
    var url = "<{:U('Pcenter/updateNewPayPassUser')}>";
    $.ajax({
        type: "post",
        url: url,
        async: false,
        data:{mobile :mobile,code:code,pass:pass,respass:respass},
        error: function() {
                layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
            },
        success:function(data){
          if(data.infor == 2){
            layer.msg('设置成功!',{offset: '300px',time: 1500,icon: 1},function () {
                window.location.reload();
            });
          }else if(data.infor == 4){
            layer.msg('两次密码不一致!',{offset: '300px',time: 1500,icon: 7}); return false;
          }else if(data.infor == 5){
            ayer.msg('验证码错误或已过期!',{offset: '300px',time: 1500,icon: 7}); return false;
          }else if(data.infor == 3){
            ayer.msg('修改失败，稍后再试!',{offset: '300px',time: 1500,icon: 7}); return false;
          }
        }
    });
})
$(window).ready(function() {
    $(".i-text").keyup(function() {
        var inp_v = $(this).val();
        var inp_l = inp_v.length;
        for (var x = 0; x <= 6; x++) {
            $(".sixDigitPassword").find("i").eq(inp_l).addClass("active").siblings("i").removeClass("active");
            $(".sixDigitPassword").find("i").eq(inp_l).prevAll("i").find("b").css({ "display": "block" });
            $(".sixDigitPassword").find("i").eq(inp_l - 1).nextAll("i").find("b").css({ "display": "none" });

            $(".guangbiao").css({ "left": inp_l * 31 }); //光标位置

            if (inp_l == 0) {
                $(".sixDigitPassword").find("i").eq(0).addClass("active").siblings("i").removeClass("active");
                $(".sixDigitPassword").find("b").css({ "display": "none" });
                $(".guangbiao").css({ "left": 0 });
            } else if (inp_l == 6) {
                $(".sixDigitPassword").find("b").css({ "display": "block" });
                $(".sixDigitPassword").find("i").eq(5).addClass("active").siblings("i").removeClass("active");
                $(".guangbiao").css({ "left": 5 * 31 });
            }


        }
    });
    var restoredSession = JSON.parse(sessionStorage.getItem('payOrderCashier'));
    var urlo = "<{:U('Order/orderdetail')}>";
    var urlc = "<{:U('Order/cartorderdetail')}>";
    if (restoredSession[0]['buyType'] == '1') {
        $(".center div a").attr("href", "#");
        $.ajax({
            type: 'post',
            url: urlo,
            data: { buyOid: restoredSession[0]['buyOid'] },
            dataType: 'json',
            error: function() {
                layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
            },
            success: function(responses) {
                if (responses.msg == 'ok') {
                    var html = "<p>万花筒 -- " + responses.goods_title + "</p>";
                    if (responses.store_name == null || responses.store_name == '') {
                        html += "<p>卖家昵称：</p>";
                    } else {
                        html += "<p>卖家昵称：" + responses.store_name + "</p>";
                    }
                    html += "<p>购买数量：" + responses.buynum + "</p>";
                    html += "<p>购买时间：" + getTime(responses.buytime) + "</p>";
                    $("#payOrder").append(html);
                    $("#dingdan").html("订单提交成功，请尽快付款！订单号："+responses.order_num);
                    $("#payprice").html(responses.price);
                    $("#payxfb").html(responses.xfb);
                    $("#paySumNum").html(responses.sumpay);
                }
            }
        });
    } else if (restoredSession[0]['buyType'] == '2') {
        $(".center div a").attr("href", "javascript:w_effect();");
        $.ajax({
            type: 'post',
            url: urlc,
            data: { buyOid: restoredSession[0]['buyOid'] },
            dataType: 'json',
            error: function() {
                layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
            },
            success: function(responses) {
                if (responses != 'no') {
                    var sum = 0;
                    var xfb = 0;
                    var sumpay = 0;
                    var tr = '<tr>';
                    for (var i = 0; i < responses.length; i++) {
                        tr += '<td>' + responses[i]['order_num'] + '</td>';
                        tr += '<td><p>' + responses[i]['goods_title'] + '</p></td>';
                        if (responses[i]['store_name'] == null || responses[i]['store_name'] == '') {
                            tr += '<td><p></p></td>';
                        } else {
                            tr += '<td><p>' + responses[i]['store_name'] + '</p></td>';
                        }
                        tr += '<td>' + responses[i]['price'] + '</td>';
                        tr += '<td>' + responses[i]['xfb'] + '</td>';
                        tr += '</tr>';
                        sum += parseInt(responses[i]['price']);
                        xfb += parseInt(responses[i]['xfb']);
                        sumpay += parseInt(responses[i]['sumpay']);
                    }
                    $("#paySumNum").html(sumpay);
                    $("#payprice").html(sum);
                    $("#payxfb").html(xfb);
                    $("#sontr").append(tr);
                    $("#dingdan").html("订单提交成功，请尽快付款！");
                    $("#duobi").html("多笔订单已合并");
                }
            }
        });
    }
});

function getTime( /** timestamp=0 **/ ) {
    var ts = arguments[0] || 0;
    var t, y, m, d, h, i, s;
    t = ts ? new Date(ts * 1000) : new Date();
    y = t.getFullYear();
    m = t.getMonth() + 1;
    d = t.getDate();
    h = t.getHours();
    i = t.getMinutes();
    s = t.getSeconds();
    // 可根据需要在这里定义时间格式
    return y + '-' + (m < 10 ? '0' + m : m) + '-' + (d < 10 ? '0' + d : d) + ' ' + (h < 10 ? '0' + h : h) + ':' + (i < 10 ? '0' + i : i) + ':' + (s < 10 ? '0' + s : s);
}

function cartCount() {}

function w_effect() {
    if ($('table').css('display') == 'none') {
        $('table').show();
    } else {
        $('table').hide();
    }
}
$("#dopay").click(function() {
    var url = "<{:U('Order/dopayorder')}>";
    var restoredSession = JSON.parse(sessionStorage.getItem('payOrderCashier'));
    var flg = restoredSession[0]['buyOid'];
    var pass = $("#payPassword_rsainput").val();
    var tel = /^[0-9]*$/;
    if (pass == '' || pass == null) {
        layer.msg('请输入支付密码', { offset: '300px', time: 1500, icon: 2 });
        return false;
    } else if (!tel.test(pass)) {
        layer.msg('请输入6位数字支付密码', { offset: '300px', time: 1500, icon: 2 });
        return false;
    }
    var index = layer.load(0, {
        shade: [0.3, '#fff'] //0.1透明度的白色背景
    });
    $.ajax({
        type: 'post',
        url: url,
        data: { buyFlg: flg, pass: pass },
        dataType: 'json',
        error: function() {
            layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
        },
        success: function(responses) {
            if (responses.msg == 'ok') {
                window.location.href = "<{:U('Pcenter/buy_list_item')}>";
            } else {
                layer.msg(responses.msg, { offset: '300px', time: 1500, icon: 2 }, function() {
                    window.location.reload();
                });
            }
        }
    });
})
</script>

</html>