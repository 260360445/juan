
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/<?php echo $_SESSION['sc']['infor']['ico']?>" type="image/x-icon" />  
<title>确认订单--万花筒</title>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/comm.min.css"></link>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/footer_header.min.css"></link>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/index.min.css"></link>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/new_join.min.css"></link>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/login_box/login_box.min.css"></link>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/goods.min.css"></link>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/static/min.css/css/front/new_index.min.css"></link>
<script type="text/javascript" src="__PUBLIC__/Home/static/js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/static/js/uaredirect.js"></script>
<style>
.yFootBottomLeft{
	width: 480px;
}
.cart_all{width:1200px;margin:10px auto;}
.cart_all>table{width:1200px;border-collapse:collapse;border-spacing:0;border:1px solid #ddd;}
.cart_all>table th{border-bottom:1px solid #ddd;font-size:14px;font-weight:normal;background-color:#eee;line-height:30px;}
.cart_all>table tr:hover{background:#eee;}
.cart_all>table td{border-bottom:1px solid #ddd;text-align:center;cursor:pointer;}
.cart_all>table td>a>img{float:left;width:50px;height:50px;margin:10px;}
.cart_all>table td>p{margin-top:24px;font-size:14px;}
.cart_all>table td>p>a{font-size:16px;color:#333333;}
.cart_all>table td>p>a:hover{color:red;}
.cart_all>table td>p>span{color:red;}
.cart_all>table td>span{color:red;}
.cart_all>table td>div{width: 120px;margin:0px auto;}
.cart_in{display:block;float:left;width:30px;height:30px;background:#eee;border:1px solid #ddd;text-align:center;line-height:28px;cursor:pointer;border-top-left-radius:3px;border-bottom-left-radius:3px;}
.cart_out{display:block;float:left;width:30px;height:30px;background:#eee;border:1px solid #ddd;text-align:center;line-height:28px;cursor:pointer;border-top-right-radius:3px;border-bottom-right-radius:3px;}
.cart_all>table td>div>input{text-align:center;display:block;float:left;outline:none;border:1px solid #ddd;margin-left:-1px;margin-right:-1px;height:30px;width:50px;}
.cart_all>table td>a{color:#333333;}
.cart_aftab{width:1198px;border:1px solid #ddd;border-top:none;overflow: hidden;}
.cart_aftab_left{float:left;margin-left:7px;line-height: 50px;}
.cart_aftab_left>span{font-size:14px;color:#555555;margin-left: 5px;float: left;}
.cart_aftab_left>input{float: left; margin-top: 19px;}
.m_l_20{margin-left:20px; cursor: pointer;}
.cart_aftab_right{float:right;}
.cart_aftab_right>p{font-size:14px;margin:0px;margin-top:20px;}
.cart_aftab_right>p>span{color:red;}
.f_s_20{font-size:20px;}
.cart_aftab_bottom{margin-top:20px;margin-left:20px;margin-bottom:10px;}
.cart_aftab_bottom>span{font-size:14px;color:#555555;}
.sel_outline{outline:none;border:1px solid red;margin-left:30px;}
.cart_aftab1{width:1198px;border:1px solid #ddd;border-top:none;}
.cart_aftab1>input{margin-left:25px;margin-top:20px;margin-bottom:20px;}
.cart_aftab1>span{font-size:14px;color:#555555;padding-left: 20px;float: left;width: 900px;margin-top: 20px;}
.cart_aftab1>span>b{font-size:28px;color:red;margin:5px;}
.pay{width:1198px;border:1px solid #ddd;border-top:none;}
.pay_top_left{float:left;font-size:16px;color:#333333;margin:20px;}
.pay_top_right{float:right;font-size:16px;color:#333333;margin:20px;display:none;}
.pay_top_right>span{font-size:20px;color:red;}
.pay_way_word{font-size:14px;color:#333333;margin-left:20px;margin-top:20px;float:left;}
.pay_ser{float:right;margin-top:20px;margin-right:20px;}
.pay_ser>span{font-size:14px;color:#555555;}
.pay_ser>b{font-size:14px;color:red;cursor:pointer;}
.pay_btn{margin-top:20px;margin-right:20px;margin-bottom:30px;}
.pay_btn>input{background:#dd2726;border:1px solid #d3141c;width:200px;height:50px;color:white;cursor:pointer;font-size:18px;}
.pay_btn>input:hover{background:#d3141c;}
.pay_ask{font-size:14px;color:#555555;margin-left:25px;line-height:25px;margin-bottom:20px;}
.forbidden{display:inline-block;width:30px;height:30px;background:#eee;border:1px solid #ddd;text-align:center;line-height:28px;border-top-left-radius:3px;border-bottom-left-radius:3px;cursor: default;}
.gtype{ background-color: #dd2726; color: #fff !important; display: inline-block;}
.c_quick_shop{
	display: block;
	width: 150px;
	height: 40px;
	color: #fff;
	background: #dd2726;
	text-align: center;
	line-height: 40px;
}
.c_no_left p{
	font-size: 30px;
	color: #666666;
	margin: 60px 0 22px;
}
.c_no_left{
	float: left;
	width: 280px;
	margin-right: 40px;
}
.c_no_right{
	float: left;
	width: 256px;
}
.c_no_goods{
	margin: 110px auto;
	width: 580px;
	overflow: hidden;
}
.c_no_right img{
	width: 114px;
	height: 133px;
	margin-top: 60px;
	margin-left: 62px;
}
.menu1{ display: none;}
.zfb{ display: none;}
.tip{padding: 10px;display: block; text-align:center; margin-bottom: 10px;}
.done{ width:40%;background:#d3141c; color: #ffffff;margin:0 11px 10px 11px; padding: 3px; display: inline-block; text-align: center; cursor:pointer;}
.reset{ width:40%;background:gray; color: #ffffff;margin:0 11px 10px 11px; padding: 3px;display: inline-block;text-align: center; cursor: pointer;}
#popup_message{padding: 0;}


.con{
	width: 1200px;
	margin: 0 auto;
}

.con .title{
	line-height: 60px;
	font-size: 18px;
	font-weight: bold;
}

.item{
	overflow: hidden;
}

.item li{
	float: left;
	width: 290px;
	margin-right: 13px;
	border: 2px solid #999;
	padding: 10px;
	box-sizing: border-box;
	height: 110px;
	position: relative;
}

.item li:last-child{
	margin: 0;
	}

.item li h3{
	font-size: 14px;
	color: #888;
	margin-bottom: 2px;
}

.item li p{
	font-size: 12px;
	color: #999;
	line-height: 16px;
	height: 32px;
	display: -webkit-box;
	-webkit-box-orient: vertical;
	-webkit-line-clamp: 2;
	overflow: hidden;
	text-overflow:ellipsis;
}

.item li a{
	
	color: red;
	display: none;
}
.item li i{
	font-weight: bold;
}
.item li span{
	position: absolute;
	right: 0;
	top: 0;
	background: rgba(0,0,0,.2);
	color: #fff;
	padding: 4px;
	font-size: 12px;
}

.item li.on{
	border: 2px solid red;
}

.item li.on::after{
	content:"√";
	position: absolute;
	background: red;
	color: #fff;
	bottom: 0;
	right: 0;
	width: 30px;
	text-align: center;
}

.item li.on a{
	display: block;
}

.sumPay{
	display: block;
	width: 0;
	margin-left:30px;
}
.cart_aftab_right p span{
	color: red;
}
.buynum {
float: left;
width: 50px;
text-align: center;
height: 30px;
border-top: 1px solid #ccc;
border-bottom: 1px solid #ccc;
line-height: 30px;
}
.cart_aftab_right p{
float: left;
margin-bottom: 30px;
}

.item li p{
	height: 0;
}
.cart_in2{
	display: block;
    float: left;
    width: 30px;
    height: 30px;
    background: #eee;
    border: 1px solid #ddd;
    text-align: center;
    line-height: 28px;
    cursor: pointer;
    border-top-left-radius: 3px;
    border-bottom-left-radius: 3px;
}
.cart_out2{
	display: block;
    float: left;
    width: 30px;
    height: 30px;
    background: #eee;
    border: 1px solid #ddd;
    text-align: center;
    line-height: 28px;
    cursor: pointer;
    border-top-right-radius: 3px;
    border-bottom-right-radius: 3px;
}
</style>	
</head>
<body>
<!--顶部nav-->
<include file="public:head" />
<!--banner上方的nav-->
	<div class="con">
		<h3 class="title">选择收货地址</h3>
		<ul class="item">
		<volist name="address_arr" id="v">
               <li data-id="<{$v['id']}>"> 
				<h3><{$v['province']}> <i><{$v['city']}></i> <i><{$v['area']}></i> (<{$v['name']}> 收)</h3>
				<if condition="$v[sta] eq 2">
					<input type="hidden" class="adsid" value="<{$v['id']}>">
				<else />
					<input type="hidden" class="adsid">
				</if>
				<h6><{$v['mobile']}></h6>
				<p><{$v['street']}></p>
				<!-- <a href="">修改</a> -->
				<if condition="$v[sta] eq 2">
					<span>默认地址</span>
				</if>
			</li>
		</volist>
			
				
		</ul>
	</div>
	<div class="cart_all">
		<h4 style="font-size: 20px;padding-bottom:10px;padding-left: 10px;">确认订单信息</h4>
		<table id="shopcart">
			<tr>
				<th>#</th>
				<th>商品</th>
				<th>分类</th>
				<th>可用金</th>
				<th>消费币</th>
				<th>数量</th>
				<th>小计</th>
				<th>操作</th>
			</tr>
			
		</table>
		<div class="cart_aftab">
			<div class="cart_aftab_top">
				<div class="cart_aftab_left">
					<input type="checkbox"  onclick="checkall(this)" checked="checked"/><span>全选<span>
				</div>
				<div class="cart_aftab_right">
					<p style="margin-right:20px;">支付可用金：<span class="f_s_20 payfor a2"></span></p>
					<p style="margin-right:20px;">支付消费币：<span class="f_s_20 payfor a1"></span></p>
					<p style="margin-right:20px;">支付总额：<span class="f_s_20 payfor a3"></span></p>
				</div>
				<div style="clear:both;"></div>
				<div class="cart_aftab1"></div>
			</div>
			<div class="cart_aftab1">
				<span><!-- 可用金余额：<b id="userMoney"><{$user_info['ke_bal']}></b> 消费币余额：<b id="userMoney"><{$user_info['xfb_bal']}></b> --></span>
				<div class="pay_btn">
					<input type="hidden" id="mid" value="<?php echo $_SESSION['sc']['id']?>"/>
					<input type="hidden" id="sta" value="<?php echo $_SESSION['sc']['status']?>"/>
					<input type="hidden" id="cart_type" value="">
					<input type="button" id="dopay" value="提交订单">
				</div>
				<div style="clear:both;"></div>
			</div>
		</div>	
	</div>
<!--foot部分-->
<!--四个图标-->
<include file="public:foot" />	
<div class="jd"></div>
<!--foot部分-->
</body>
<script type="text/javascript" src="/Public/Home/static/min.js/js/include/footer_header_new.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/static/js/jquery-1.11.3.js"></script>
<script src="__PUBLIC__/Admin/javascripts/layer/layer.js"></script>
<script>
function cartCount() {
    var url = "<{:U('Cart/cartCount')}>";
    $.ajax({
        url: url,
        type: 'POST',
        dataType: 'json',
        data: '',
        success:function(data){
            if(data > 0){
                $("#cartCount").html(data);
                $("#cartCount").addClass("num-rt");
                $("#row").html(data);
            }else{
                $("#cartCount").html("");
            }
        }
    });
}
function CartOrder(){
    var a = $("#mid").val();
    var b = $("#sta").val();
    if(null != a && "" != a){
        if(b == '2'){//账号处于激活状态
            window.location.href="<{:U('Cart/cart')}>"; 
        }else if(b == '3'){//账号处于冻结状态
            layer.msg('账号处于冻结状态,请联系管理员解封',{offset: '300px',time: 2000,icon: 7});
        }
    }else{
        go2Login();
    }
}
$(function(){
    // 然后是如何转换通过 JSON.stringify 生成的字符串，该字符串以 JSON 格式保存在 localStorage 里
    var restoredSession = JSON.parse(sessionStorage.getItem('buyNum'));
    var url = "<{:U('Order/ajaxGoods')}>";
	// 现在 restoredSession 包含了保存在 localStorage 里的对象
	if(sessionStorage.getItem('buyType') == 1){
		$.ajax({
	        url: url,
	        type: 'POST',
	        dataType: 'json',
	        async : false,
	        data: {buyType:sessionStorage.getItem('buyType'),itemid: restoredSession[0]['gid'],buynum:restoredSession[0]['buyNum']},
	        success:function(data){
	           	if(data){
	           		$("#shopcart").append(data);
	           	}
	        }
	    });
    	sessionStorage.getItem('buyType')?$("#cart_type").val(sessionStorage.getItem('buyType')): $("#cart_type").val(1);	
	}else if(sessionStorage.getItem('buyType') == 2){
		// 现在 restoredSession 包含了保存在 localStorage 里的对象
		$.ajax({
	        url: url,
	        type: 'POST',
	        dataType: 'json',
	        async : false,
	        data: {buyType:sessionStorage.getItem('buyType'),item:restoredSession},
	        success:function(data){
	           	if(data){
	           		$("#shopcart").append(data);
	           	}
	        }
	    });
		sessionStorage.getItem('buyType')?$("#cart_type").val(sessionStorage.getItem('buyType')): $("#cart_type").val(2);
	}
    
})
</script>
<script type="text/javascript">
$(function(){
	add();
})
var j = 0;
var o = 0;
var w = 0;
// 合计金额函数封装
function add(){
	var aa =$('#shopcart').children('tbody').children('tr').children('td').children('.sumPay');
	var ipt = $('#shopcart .check_alls');
	j = 0;
	o = 0;
	w = 0;
	for (var i = 0; i < $('#shopcart .check_alls').length; i++) {
		if($(ipt[i]).is(':checked')){
			o = o + parseInt($(ipt[i]).parent().siblings().children('.sumPay').html());//总额
			w = w + parseInt($(ipt[i]).parent().siblings().children('.payNum').html() * $(ipt[i]).parent().siblings().children('.datatype').children('.buynum').html());//可用金
			j = j + parseInt($(ipt[i]).parent().siblings().children('.xfbNum').html() * $(ipt[i]).parent().siblings().children('.datatype').children('.buynum').html());//消费币
		}
	}
	// console.log(o)
	$('.cart_aftab_right p span.a1').html(j );//消费币
	$('.cart_aftab_right p span.a2').html(w);//可用金
	$('.cart_aftab_right p span.a3').html(o );//总额
}

function checkall(qx){
  $(".check_alls").prop("checked",qx.checked);
  add();
}
$(function(){
	// 点击 + 
	$('.cart_out').click(function(){		
		if($(this).parent().parent().siblings().children('.check_alls').is(':checked')){
			i = parseInt($(this).siblings('.buynum').html());
			limit= parseInt($(this).siblings('.buynum').parents('div').data('limit'));
			gid= parseInt($(this).siblings('.buynum').parents('div').data('id'));
			if(i >= limit){//最大值
				i = limit;
			}else {
				num = i++;
			}
			$(this).siblings('.buynum').html(i);
			$(this).parent().parent().next().children('.sumPay').html(i * $(this).parent().parent().siblings().children('.payNum').html()+i * $(this).parent().parent().siblings().children('.xfbNum').html());
			add();
			$('.cart_aftab_right p span.a1').html(j );
			$('.cart_aftab_right p span.a2').html(w);
			$('.cart_aftab_right p span.a3').html(o );
			$("#buynum_"+gid).val(i);
		}
	})
	// 点击-
	$('.cart_in').click(function(){
		
		if($(this).parent().parent().siblings().children('.check_alls').is(':checked')){
			i = parseInt($(this).siblings('.buynum').html());
			gid= parseInt($(this).siblings('.buynum').parents('div').data('id'));
			if(i <= 1){
				i = 1;
			}else {
				num = i--;
			}
			$(this).siblings('.buynum').html(i);
			$(this).parent().parent().siblings().children('.sumPay').html(i * $(this).parent().parent().siblings().children('.payNum').html()+i * $(this).parent().parent().siblings().children('.xfbNum').html());
			add();
			$('.cart_aftab_right p span.a1').html(j );
			$('.cart_aftab_right p span.a2').html(w);
			$('.cart_aftab_right p span.a3').html(o );
			$("#buynum_"+gid).val(i);
		}

	})
	// 判断是否选中
	var ipt = $('#shopcart .check_alls');
	var nub = 0;
	var nub1 = 0;
	var nub2 = 0;
	ipt.change(function(){
		add();	
	})
	$('#dopay').click(function(){
		var index = layer.load(0, {
			  shade: [0.3,'#fff'] //0.1透明度的白色背景
			});
		var type=$("#cart_type").val();
		var adsid=$(".adsid").val();
		var a = /^\d{6}$/;
		if(type == 1){
			var gid=$("input[name=goodid]").val();
			var num=$("#buynum_"+gid).val();
			var url = "<{:U('Order/payorder')}>";
			$.ajax({
                type: "POST",
                url: url,
                data: {num:num,gid:gid,adsid:adsid},
                dataType: 'json',
                error : function () {
	            	layer.msg('网络故障，请稍后重试!',{offset: '300px',time: 2000,icon: 7});
	          	},
                success: function(data){
                	if (data.msg == 'ok'){
                		var d=[];
					    d.push({buyOid: data.flg,buyType:data.buytype,gid:data.gid});
					    sessionStorage.setItem("payOrderCashier",JSON.stringify(d));
	                    window.location.href = "<{:U('Order/paycashier')}>";
	            	}else{
	            		sessionStorage.clear();//清空缓存数据
	                	layer.msg(data.msg,{offset: '300px',time: 2000,icon: 2},function () {
	                    	window.location.reload();
	                  	});
	                	return false;
	            	}
                }
            });
		}else if(type == 2){
			var buy=[]; 
			var num='';
			var url = "<{:U('Order/cartPayOrder')}>";
		    $("input[name=items]").each(function(k,v) {  
		        if ($(this).is(":checked")) { 
		        	buynum=$("#buynum_"+$(this).val()+"").val();
		        	buy.push({gid:$(this).val(),num:buynum});	
		        }
		    });
		    if(buy == ""){
		    	layer.msg('请选择商品',{offset: '300px',time: 2000,icon: 2});
		    	return false;
		    }else{
		    	$.ajax({
	                type: "POST",
	                url: url,
	                data: {item:buy,adsid:adsid},
	                dataType: 'json',
	                error : function () {
		            	layer.msg('网络故障，请稍后重试!',{offset: '300px',time: 2000,icon: 7});
		          	},
	                success: function(data){
	                	if (data.msg == 'ok'){
		                	var d=[];
						    d.push({buyOid: data.flg,buyType:data.buytype});
						    sessionStorage.setItem("payOrderCashier",JSON.stringify(d));
		                    window.location.href = "<{:U('Order/paycashier')}>";
		            	}else{
		            		sessionStorage.clear();//清空缓存数据
		                	layer.msg(data.msg,{offset: '300px',time: 2000,icon: 2},function () {
		                    	window.location.reload();
		                  	});
		                	return false;
		            	}
	                }
	            });	
		    }
		}
	})
})
</script>
</html>
<script type="text/javascript">
$('.con ul li').click(function(obj){
	var id = $(this).data('id');
	var ss=$(".adsid").val(id);
	$(this).addClass('on').siblings().removeClass();
})
$(".del").click(function(){
	var url = "<{:U('Order/orderdel')}>";
    var id=$("input[name=goodid]").val();
    layer.confirm('您确定要删除吗？', {
      btn: ['确定','取消'] //按钮
    }, function(){
        $.ajax({
            type : 'post',
            url : url,
            data : {id:id},
            error : function () {
                layer.msg('网络故障，请稍后重试!',{offset: '300px',time: 1500,icon: 7});
            },
            success : function (responses) {
                if (responses == 'ok'){
                    layer.msg('修改成功',{offset: '300px',time: 1500,icon: 1},function () {
                       window.location.reload();
                    });
                }else{
                    layer.msg(responses,{offset: '300px',time: 1500,icon: 2});
                }
            }
        });
    });
})
</script>