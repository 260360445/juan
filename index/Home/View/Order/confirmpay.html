<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script type="text/javascript" src="__PUBLIC__/Home/static/js/jquery-1.11.3.js"></script>
 <link rel="shortcut icon" href="/<?php echo $_SESSION['sc']['infor']['ico']?>" type="image/x-icon" />
<link rel="stylesheet" href="__PUBLIC__/Home/static/min.css/new/css/header_footer.min.css"/>
<link rel="stylesheet" href="__PUBLIC__/Home/static/userCenter/css/login.css"/>
<link rel="stylesheet" href="__PUBLIC__/Home/static/css/front/login_box/login_box.css"/>
<link rel="stylesheet" href="__PUBLIC__/Home/static/new/css/deal.css"/>
<title>确认收货--万花筒</title>
<style type="text/css">
    .order_info_con ul li{
        line-height: 36px;
    }
</style>
</head>
<body>
	<include file="public:head" />
	<div class="inner">
		<div class="deal_header">
			<p>您的位置：</p>
			<a href="/">首页 <span>></span></a>
			<a href="<{:U('Pcenter/account')}>">个人中心 <span>></span></a>
			<a href="#">订单详情</a>
		</div>
		<div class="deal_content">
			<ul class="schedule">
				<li class="current">1. 拍下商品</li>
				<if condition="$info[state] eq 2">
					<li class="current">2. 已付款</li>
                    <li class="current">3. 卖家发货</li>
					<li >4. 确认收货</li>
				<elseif condition="$info[state] eq 3"/> 
					<li class="current">2. 已付款</li>
                    <li >3. 卖家发货</li>
					<li >4. 确认收货</li>
				<elseif condition="$info[state] eq 4"/> 
					<li class="current">2. 已付款</li>
                    <li class="current">3. 卖家发货</li>
					<li class="current">4. 确认收货</li>
				<elseif condition="$info[state] eq 5"/> 
					<li >2. 已付款</li>
                    <li >3. 卖家发货</li>
					<li >4. 确认收货</li>
				</if>
			</ul>
			<div class="table">
				<table>
					<tr>
						<th>商品</th>
						<th>可用金</th>
						<th>消费币</th>
						<th>数量</th>
						<th>状态</th>
					</tr>
					<tr>
						<td>
							<a href="<{:U('Good/goodlist',['id'=>$info['id']])}>" target="_blank">
							<img src="__ROOT__/Uploads<{$info.goods_logo}>" alt="">
							<{$info['goods_title']}></a>
						</td>
						<td>
							<{$info['price']}>
						</td>
						<td>
							<{$info['xfb']}>
						</td>
						<td>
							<{$info['buynum']}>
						</td>
						<td>
							<if condition="$info[state] eq 2">
								已发货
							<elseif condition="$info[state] eq 3"/> 
								未发货
							<elseif condition="$info[state] eq 4"/> 
								确认收货
							<elseif condition="$info[state] eq 5"/> 
								等待付款
							</if>
						</td>
					</tr>
				</table>
			</div>
			<div class="product_info">
				<ul>
					<li>
						<p>商品总价：</p>
						<span>￥<{$info['sumpay']}></span>
					</li>
					<li>
						<p>运费（快递）：</p>
						<span>￥0.00</span>
					</li>
					<li>
						<h3>订单总价：</h3>
						<i>￥<{$info['sumpay']}></i>
					</li>
					<li>
						<h3>实付款：</h3>
						<em>￥<{$info['sumpay']}></em>
					</li>
				</ul>
			</div>
		</div>
		<div class="order_info_con">
			<ul>
				<?php
					$store=M('store')->field('store_name')->where(['sj_id'=>$info['sid']])->find();
				?>
				<li>
					<p>订单编号：</p><span><{$info['order_num']}></span>
				</li>
				<li>
					<p>下单时间：</p><span><{:date('Y-m-d H:i:s',$info['buytime'])}></span>
				</li>
				<li>
					<?php if($address['express_time']){?>
						<p>发货时间：</p><span><{:date('Y-m-d H:i:s',$address['express_time'])}></span>
					<?php }else{?>
						<p>发货时间：</p><span>未发货</span>
					<?php }?>
				</li>
				<li>
					<?php if($address['express_user']){?>
						<p>收货地址：</p><span><{$address['express_user']}></span>
					<?php }else{?>
						<p>收货地址：</p><span>未发货</span>
					<?php }?>
				</li>
				<li>
					<p>商家：</p><span><{$store['store_name']}></span>
				</li>
			</ul>
		</div>
		<div class="pay_password">
			<ul>
				<li>请收到货后，再确认收货！否则您可能钱财两空！</li>
			</ul>
			<div class="pay_password_con">
				<h3>
					<img src="__PUBLIC__/Home/static/new/img/images/safe.png" alt="" />
					安全设置检测成功！
				</h3>
				<h4>万花筒支付密码：</h4>
	            <div class="alieditContainer" id="payPassword_container">
	                <input minlength="6" maxlength="6" tabindex="1" id="payPassword_rsainput" name="payPassword_rsainput" class="ui-input i-text" oncontextmenu="return false" onpaste="return false" oncopy="return false" oncut="return false" autocomplete="off"  type="password" >
	                <div class="sixDigitPassword" tabindex="0">
	                    <i class="active"><b></b></i>
	                    <i><b></b></i>
	                    <i><b></b></i>
	                    <i><b></b></i>
	                    <i><b></b></i>
	                    <i><b></b></i>
	                </div>
	            </div>
	            <a href="javascript:setPayPass();">忘记密码？</a>
				<p>请输入6位数字支付密码</p>
				<button type="button" id="dopay">确定</button>
			</div>

		</div>
	</div>
	<include file="public:pfoot" />
</body>
<style>
.loginContent{
    padding: 25px 0 0;
}
.a_login_register_box form .code span{
        position: absolute;
    display: block;
    width: 25px;
    height: 23px;
    background: url(/Public/Home/static/img/icon/input-icon-all.png) no-repeat 0 -387px;
    margin: 11px 12px;
    padding-right: 5px;
    border-right: 1px solid #dcdcdc;
}
</style>
<div class="a_login_fixed_box a_login_register_box loginContent" style="z-index:1012;">
    <form class="a_login_register_form a_login_form">
        <div class="user" id="user">
           <span></span>
           <input type="text" id="mobile" class="border" readonly="readonly" value="<?php echo $_SESSION['sc']['usermobile']?>" maxlength="11"/>
        </div>
        <div class="code user" id="user">
        <span></span>
           <input type="text" id="code" class="border" placeholder="验证码" datacol='yes' checkexpession='NotNull' err='验证码' maxlength="11" style="width: 148px;" /><a href="javascript:getUserCode();" class="a_login_btn_go a_paypass_btn_go" style="display: inline-block;width: 90px;height: 46px;border-radius: 4px;margin-left: 20px;">手机验证码</a>
        </div>
        <div class="pas" id="pas">
           <span></span>
           <input type="password" id="paypass"  maxlength="6" placeholder="新密码" datacol='yes' checkexpession='Num' err='新密码不能为空，并且'/>
        </div>
        <div class="pas" id="pas">
           <span></span>
           <input type="password" id="respaypass"  maxlength="6" placeholder="确认密码" datacol='yes' checkexpession='Num' err='确认密码不能为空，并且'/>
        </div>
        <a href="javascript:void(0);" class="a_login_btn_go" id="paySubmit">重置密码</a>
    </form>
    <span class="a_world_close a_login_world_close"></span>

</div>
<div class="a_world_bg" style="z-index:1011"></div>
<script src="__PUBLIC__/Admin/javascripts/layer/layer.js"></script>
<script src="__PUBLIC__/Admin/javascripts/JValidator.js"></script>
<script type="text/javascript">
function setPayPass(){
    var a = $(window).width(),
        c = $(window).height();
    $(".a_world_bg").css({
        height: c + "px"
    });
    $(".a_login_fixed_box").css({
        left: (a - $(".a_login_fixed_box").outerWidth()) / 2 + "px",
        top: (c - $(".a_login_fixed_box").outerHeight()) / 2 + "px"
    });
    $(".a_register_fixed_box").css({
        left: (a - $(".a_register_fixed_box").outerWidth()) / 2 + "px",
        top: (c - $(".a_register_fixed_box").outerHeight()) / 2 + "px"
    });
    $(".a_login_fixed_box").show();
    $(".a_world_bg").show();
    $(".a_login_world_close").click(function () {
        $(".a_world_bg").hide();
        $(".a_login_fixed_box").hide()
    })
}
function getUserCode(){
    var mobile=$("#mobile").val();
    var isMobile = /^0?1[3-8][0-9]\d{8}$/; // 手机号码验证规则
    if(mobile == '' || mobile == null){
        VerifyFailed('mobile','请填写手机号！');
        return false;
    } else if (!isMobile.test(mobile)) {
        VerifyFailed('mobile','手机号格式不正确！');
        return false;
    }else{
        checkValidCode();
    }
}
  /*发送验证码*/
function checkValidCode(){
  var mobile = $("#mobile").val();
  var time=120;
  var url = "<{:U('Register/checkValidCodeUSer')}>";
  $.ajax({
    type: "post",
    url: url,
    async: false,
    data:{mobile :mobile},
    error: function() {
                layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
            },
    success:function(data){
      if(data.infor == 2){
         $(".a_paypass_btn_go").attr("href","#");
          var t=setInterval(function  () {
          time--;
               $(".a_paypass_btn_go").html(time+"秒后获取");
              if (time==0) {
                  clearInterval(t);
                  $(".a_paypass_btn_go").attr("href","javascript:getUserCode();");
                  $(".a_paypass_btn_go").html("重新获取");
              }
          },1000) 
      }else if(data.infor == 3){
        layer.msg('验证码发送失败!',{offset: '300px',time: 1500,icon: 7}); return false;
      }else if(data.infor == 4){
        VerifyFailed('mobile','手机号不已存在，请填写新的手机号！'); return false;
      }
    }
  });
}
$("#paySubmit").click(function(){
    var mobile=$("#mobile").val();
    var code=$("#code").val();
    var pass=$("#paypass").val();
    var respass=$("#respaypass").val();
    var isMobile = /^0?1[3-8][0-9]\d{8}$/; // 手机号码验证规则
    if(mobile == '' || mobile == null){
        VerifyFailed('mobile','手机号码不能为空！');
        return false;
    }
    if (!isMobile.test(mobile)) {
        VerifyFailed('mobile','手机号格式不正确！');
        return false;
    }
    if(!/^[0-9]*$/.test(code)){
      VerifyFailed('code','短信验证码格式不正确！');
      return false;
    }
    if(pass == '' || pass == null){
        VerifyFailed('pass','请填写支付密码！');
        return false;
    }
    if(respass == '' || respass == null){
        VerifyFailed('pass','请填写确认密码！');
        return false;
    }
    if(pass != respass){
        VerifyFailed('respaypass','两次密码不一致！');
        return false;
    }
    var url = "<{:U('Pcenter/updateNewPayPassUser')}>";
    $.ajax({
        type: "post",
        url: url,
        async: false,
        data:{mobile :mobile,code:code,pass:pass,respass:respass},
        error: function() {
                layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 });
            },
        success:function(data){
          if(data.infor == 2){
            layer.msg('设置成功!',{offset: '300px',time: 1500,icon: 1},function () {
                window.location.reload();
            });
          }else if(data.infor == 4){
            layer.msg('两次密码不一致!',{offset: '300px',time: 1500,icon: 7}); return false;
          }else if(data.infor == 5){
            ayer.msg('验证码错误或已过期!',{offset: '300px',time: 1500,icon: 7}); return false;
          }else if(data.infor == 3){
            ayer.msg('修改失败，稍后再试!',{offset: '300px',time: 1500,icon: 7}); return false;
          }
        }
    });
})
//确认收货
$("#dopay").click(function() {
    var url = "<{:U('Order/setOrder')}>";
    var flg = <?php echo $info['order_id']?>;
    var pass = $("#payPassword_rsainput").val();
    var tel = /^[0-9]*$/;
    if (pass == '' || pass == null) {
        layer.msg('请输入支付密码', { offset: '300px', time: 1500, icon: 2 });
        return false;
    } else if (!tel.test(pass)) {
        layer.msg('请输入6位数字支付密码', { offset: '300px', time: 1500, icon: 2 });
        return false;
    }
    var index = layer.load(0, {
        shade: [0.3, '#fff'] //0.1透明度的白色背景
    });
    $.ajax({
        type: 'post',
        url: url,
        data: { buy: flg, pass: pass },
        dataType: 'json',
        error: function() {
            layer.msg('网络故障，请稍后重试!', { offset: '300px', time: 1500, icon: 7 }, function() {
                window.location.reload();
            });
        },
        success: function(responses) {
            if (responses.msg == 'ok') {
            	layer.msg('付款成功，货款会直接付给商家!', { offset: '300px', time: 1500, icon: 1 }, function() {
	                window.location.href = "<{:U('Pcenter/buy_list_item')}>";
	            });
            } else {
                layer.msg(responses.msg, { offset: '300px', time: 1500, icon: 2 }, function() {
                    window.location.reload();
                });
            }
        }
    });
})
$(document).ready(function(){
	$(".i-text").keyup(function() {
        var inp_v = $(this).val();
        var inp_l = inp_v.length;
        for (var x = 0; x <= 6; x++) {
            $(".sixDigitPassword").find("i").eq(inp_l).addClass("active").siblings("i").removeClass("active");
            $(".sixDigitPassword").find("i").eq(inp_l).prevAll("i").find("b").css({ "display": "block" });
            $(".sixDigitPassword").find("i").eq(inp_l - 1).nextAll("i").find("b").css({ "display": "none" });

            $(".guangbiao").css({ "left": inp_l * 31 }); //光标位置

            if (inp_l == 0) {
                $(".sixDigitPassword").find("i").eq(0).addClass("active").siblings("i").removeClass("active");
                $(".sixDigitPassword").find("b").css({ "display": "none" });
                $(".guangbiao").css({ "left": 0 });
            } else if (inp_l == 6) {
                $(".sixDigitPassword").find("b").css({ "display": "block" });
                $(".sixDigitPassword").find("i").eq(5).addClass("active").siblings("i").removeClass("active");
                $(".guangbiao").css({ "left": 5 * 31 });
            }
        }
	});
})
</script>
</html>